<!DOCTYPE html>
<html>
<head>
    <title>Изборни резултати по населени места</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
	<style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #map { 
            width: 100%;
            height: 100%; 
        }
        
        .map-container {
            position: relative; 
            width: 100vw;
            height: 100vh;
        }
        
        .dropdown-container {
            position: absolute; 
            top: 10px;
            left: 50px;  
            background-color: rgba(255, 255, 255, 0.8); 
            padding: 5px;
            border-radius: 5px;
            z-index: 1000; 
        }
        
        .info { 
            padding: 6px 8px; 
            font: 14px/16px Arial, Helvetica, sans-serif; 
            background: white; 
            background: rgba(255,255,255,0.8); 
            box-shadow: 0 0 15px rgba(0,0,0,0.2); 
            border-radius: 5px; 
        }
        
        .info h4 { 
            margin: 0 0 5px; 
            color: #777; 
        }
        
        .legend { 
            text-align: left; 
            line-height: 18px; 
            color: #555; 
        }
        
        .legend i { 
            width: 18px; 
            height: 18px; 
            float: left; 
            margin-right: 8px; 
            opacity: 0.7; 
        }

        .info-box {
            position: absolute;
            top: 50px; 
            left: 20px; 
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            z-index: 1000; 
            font: 14px/16px Arial, Helvetica, sans-serif; 
        }
    </style>
</head>

<body>
<div class="map-container">
    <div id="map"></div>
    <div class="dropdown-container">
        <select id="csvDropdown">
            <option value="../../assets/data/data_mar17_pct.csv">Март 2017</option>
            <option value="../../assets/data/data_apr21_pct.csv">Април 2021</option>
            <option value="../../assets/data/data_jul21_pct.csv">Юли 2021</option>
            <option value="../../assets/data/data_nov21_pct.csv">Ноември 2021</option>
            <option value="../../assets/data/data_oct22_pct.csv">Октомври 2022</option>
            <option value="../../assets/data/data_apr23_pct.csv">Април 2023</option>
            <option value="../../assets/data/data_jun24_pct.csv" selected>Юни 2024 (предварителни)</option>
        </select>
        <br>
        <select id="columnsDropdown"></select>
    </div>
</div>
<div id="infoBox" class="info-box" style="display:none;">
    Изборните данни са от <a href=https://results.cik.bg>ЦИК</a>.<br>
    Границите на населените места са от <a href=https://www.nsi.bg/nrnm/spatial-data>НСИ</a>.<br>
    За коментари и намерени грешки: <a href=https://twitter.com/petar_baka>@petar_baka</a>.<br>
    <button onclick="closeInfoBox()">Затвори</button>
</div>
</body>
</html>

<script type='text/javascript'>
    let csvData;
    let geojsonData;
    let map;
    let geojsonLayer;
	var info = L.control();
    let selectedColumn = null;
    
    document.getElementById("csvDropdown").addEventListener("change", function(event) {
        loadCSV(event).then(populateDropdown);
    });

    loadGeoJSON().then(initializeMap);

    function loadCSV(event) {
        const csvFilename = event.target.value;
    
        return new Promise((resolve, reject) => {
            Papa.parse(csvFilename, {
                download: true,
                header: true,
                dynamicTyping: true,
                complete: (result) => {
                    csvData = result.data;
                    resolve(result);  
                },
                error: (error) => {
                    reject(error); 
                }
            });
        });
    }
    
    function loadGeoJSON() {
      return fetch("../../assets/data/settlements_simplified1pct.json")
        .then((response) => response.json())
        .then((data) => {
          geojsonData = data;
          return loadCSV({ target: { value: "../../assets/data/data_jun24_pct.csv" } }); 
        });
    }

    function matchData(columnName) { // TODO: get rid of this (no need to add data to the GeoJSON features; you can fetch data dynamically from the csv as needed)
      geojsonData.features.forEach((feature) => {
        const match = csvData.find((row) => ('00000' + row.id).slice(-5) === feature.properties.ncode); 
        if (match) {
          feature.properties[columnName] = match[columnName];
          feature.properties['total'] = match['total']; 
          feature.properties['eligible_voters'] = match['eligible_voters']; 
          feature.properties['активност'] = match['активност']; 
        } else {
          feature.properties[columnName] = NaN;
          feature.properties['total'] = NaN; 
          feature.properties['eligible_voters'] = NaN; 
          feature.properties['активност'] = NaN; 
        }
      });
    }

    function getColor(d) {
		return d > .8 ? '#800026' :
			d > .7  ? '#BD0026' :
			d > .6  ? '#E31A1C' :
			d > .4  ? '#FC4E2A' :
			d > .2   ? '#FD8D3C' :
			d > .1   ? '#FEB24C' :
			d > .05   ? '#FED976' : '#FFEDA0';
	}

    function style(feature) {
		return {
			weight: 2,
			opacity: 1,
			color: 'white',
			dashArray: '3',
			fillOpacity: 0.7,
            fillColor: getColor(feature.properties[selectedColumn]),
		};
	}

    function highlightFeature(e) {
		var layer = e.target;

		layer.setStyle({
			weight: 5,
			color: '#666',
			dashArray: '',
			fillOpacity: 0.7
		});

		if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
			layer.bringToFront();
		}

		info.update(layer.feature.properties, selectedColumn);
	}

    function zoomToFeature(e) {
		map.fitBounds(e.target.getBounds());
	}


    function resetHighlight(e) {
		geojsonLayer.resetStyle(e.target);
		info.update(undefined, selectedColumn);
	}

    function onEachFeature(feature, layer) {
		layer.on({
			mouseover: highlightFeature,
			mouseout: resetHighlight,
			click: zoomToFeature,
			dbclick: function(e) {
                highlightFeature(e);
                zoomToFeature(e);
            }
		});
	}

    function initializeMap() {
	  map = L.map('map').setView([42.934, 25.938], 8);
    
	  var tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
	  	maxZoom: 19,
	  	attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>|<a href="https://twitter.com/petar_baka">petar_baka</a>'
	  }).addTo(map);

      geojsonLayer = L.geoJson(geojsonData, {
       	style: style,
      	onEachFeature: onEachFeature
      }).addTo(map);

      info.onAdd = function (map) {
	  	this._div = L.DomUtil.create('div', 'info');
	  	this.update();
	  	return this._div;
	  };

      info.update = function (props, selectedColumn) {
        var selectedYear = document.getElementById('csvDropdown');
        var selectedYearText = selectedYear.options[selectedYear.selectedIndex].textContent;;
        var table = ''; 
	  	var textbox = '<h4>Резултати ' + selectedColumn + ' (' + selectedYearText + ')</h4>';

        if (props) {
            table = generateTableHtmlForRowById(props.ncode);

            textbox += '<b>' + props.name + ' (' + props.ncode + ')</b><br>';

            if (selectedColumn !== 'активност') {
                textbox += selectedColumn + ' гласове: ' +  Math.round(props[selectedColumn]*props['total']) + '<br>' 
                //textbox += selectedColumn + ` %: ${isNaN(props[selectedColumn]) ? props[selectedColumn] : (100*props[selectedColumn]).toFixed(1)}<br>`
            } else {
                // TODO: breakdown valid votes, invalid votes, total 
                // TODO: breakdown initial voter list, added to voter list, total 
                textbox += 'Общо валидни гласове: ' +  Math.round(props[selectedColumn]*props['eligible_voters']) + '<br>' 
                textbox += 'Избиратели по списък: ' +  props['eligible_voters'] + '<br>'
                //textbox += `Валидни гласове/избиратели по списък: ${isNaN(props[selectedColumn]) ? props[selectedColumn] : props[selectedColumn].toFixed(2)}<br>`
            }
            textbox += selectedColumn + ` (%): ${isNaN(props[selectedColumn]) ? props[selectedColumn] : (100*props[selectedColumn]).toFixed(1)}<br>`
            textbox += table + '<br>'
            textbox += 'Общо валидни гласове: ' +  props['total']  + '<br>'
            textbox += 'Избиратели по списък: ' +  props['eligible_voters'] + '<br>'
            textbox += `Валидни гласове/избиратели по списък: ${isNaN(props['активност']) ? props['активност'] : props['активност'].toFixed(2)}<br>`
            //textbox += `Валидни гласове/избиратели по списък: ${isNaN(props['total']) ? 'no data' : (props['total']/props['eligible_voters']).toFixed(2)}<br>`
        } else {
            textbox += 'Посочете населено место.'
        };

	  	this._div.innerHTML = textbox;
	  };

	  info.addTo(map);

      var legend = L.control({position: 'bottomleft'});

      legend.onAdd = function (map) {

          var div = L.DomUtil.create('div', 'info legend');
          var grades = [0, 0.05, 0.1, .2, .4, .6, .7, .8]; 
          var labels = [];
          var from, to;

          for (var i = 0; i < grades.length; i++) {
              from = grades[i];
              to = grades[i + 1];

              labels.push(
                  '<i style="background:' + getColor(from + 0.0001) + '"></i> ' +
                  from + (to ? '&ndash;' + to : '+'));
          }

          div.innerHTML = labels.join('<br>');
          return div;
      };

      legend.addTo(map);

      populateDropdown();
      document.getElementById("columnsDropdown").addEventListener("change", updateColumn);

      L.Control.InfoButton = L.Control.extend({
          onAdd: function(map) {
              var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
      
              container.style.backgroundColor = 'white';     
              container.style.width = '30px';
              container.style.height = '30px';
              container.innerHTML = 'i'; 
              container.style.fontSize = '18px';
              container.style.textAlign = 'center';
              container.style.lineHeight = '30px';
              container.style.cursor = 'pointer';
      
              container.onclick = function(){
                  openInfoBox();
              }
      
              return container;
          }
      });
      
      var infoButton = new L.Control.InfoButton({ position: 'topleft' });
      infoButton.addTo(map);
  
    }

    function populateDropdown() {
      const dropdown = document.getElementById("columnsDropdown");
      const columns = Object.keys(csvData[0]);
      let parties = [];
      const excluded = ['id', 'eligible_voters', 'total'];

      dropdown.innerHTML = ''; 
    
      columns.forEach((column) => {
        
        if (! excluded.includes(column)) { 
          const option = document.createElement("option");
          option.value = column;
          option.textContent = column;
          dropdown.appendChild(option);
          parties.push(column)
        }
      });
   
      if ((selectedColumn == null) || !( columns.includes(selectedColumn))) { 
        selectedColumn = parties[0]; 
      } else if (columns.includes(selectedColumn)) {
        dropdown.value = selectedColumn;
      };

      matchData(selectedColumn);
      geojsonLayer.setStyle(feature => {
        return {
          fillColor: getColor(feature.properties[selectedColumn]),
          
        };
      });

      info.update(undefined, selectedColumn);
    }
    
    function updateColumn(event) {
      selectedColumn = event.target.value;
      matchData(selectedColumn);
      geojsonLayer.setStyle(feature => {
        return {
          fillColor: getColor(feature.properties[selectedColumn]),
          
        };
      });
      info.update(undefined, selectedColumn);
    }

    function generateTableHtmlForRowById(targetId) {
        
        const targetRow  = csvData.find((row) => ('00000' + row.id).slice(-5) === targetId); 

        if (!targetRow) return '';
    
        let html = '<table>';
    
        html += '<thead><tr>';
        html += '<th>Партия</th>';
        html += '<th>Гласове</th>';
        html += '<th>Пропорция</th>';
        html += '</tr></thead>';
    
        html += '<tbody><tr>';
        for (let key in targetRow) {
            if (key !== "total" && key !== "id" && key !== 'eligible_voters' && key !== 'активност') {  
                const originalValue = targetRow[key];
                const multipliedValue = originalValue * targetRow.total;

                html += `<tr>`;
                html += `<td>${key}</td>`;
                html += `<td>${Math.round(multipliedValue)}</td>`;
                html += `<td>${isNaN(originalValue) ? originalValue : originalValue.toFixed(2)}</td>`;
                html += `</tr>`;
            }
        }
        html += '</tr></tbody>';
    
        html += '</table>';
        return html;
    }
    
    function openInfoBox() {
        document.getElementById('infoBox').style.display = 'block';
    }
    
    function closeInfoBox() {
        document.getElementById('infoBox').style.display = 'none';
    }


</script>
