<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Македонски миграции</title>
    <style>
    html,body{
        margin: 0;
        padding: 0;
    }
    #map{
        position: absolute;
        height: 100%;
        width: 100%;
    }
    .controls-container {
      position: absolute;
      top: 10px; 
      left: 50px; 
      background-color: rgba(255, 255, 255, 0.8); 
      padding: 10px;
      border-radius: 5px;
      z-index: 1000; 
      font: 14px/16px Arial, Helvetica, sans-serif;
    }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src='../assets/js/migrationLayer.js'></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

</head>

<body>
    <div id="map"></div>
    <div class="controls-container">
        <label for="atLeast">Скрий населени места с под:</label>
        <input type="range" id="atLeast" min="1" max="559" value="10" step="1">
        <span id="leastDisplay">50</span>
        <span>починали</span></br>

        <label for="atMost">Скрий населени места с над:</label>
        <input type="range" id="atMost" min="0" max="559" value="559" step="1">
        <span id="mostDisplay">559</span>
        <span>починали</span></br>

        <label for="minPairWeight">Скрий н.м. свързани с по-малко от:</label>
        <input type="range" id="minPairWeight" min="1" max="69" value="3" step="1">
        <span id="minWeightDisplay">3</span>
        <span>души</span></br>

        <select id="toDropdown" value=''></select></br>
        <select id="fromDropdown" value=''></select></br>
        <span id="countDisplay"></span></br>
        Виж таблица с поименните данни <a href='index.html'>тук</a>.
    </div>
    <script>
        var lrmap = L.map('map').setView([41, 25], 7);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Map data <a href="https://wikidata.org">wikidata</a>|©<a href="https://openstreetmap.org">OpenStreetMap</a>|<a href="https://twitter.com/petar_baka">petar_baka</a>'
        }).addTo(lrmap);

        let data3;
        let filteredData;
        let migrationLayer;
        let tCount;

        Papa.parse('../assets/data/migration_data.csv', {
            download: true,
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true, 
            transform: function(value, header) {
                if (header === 'from' || header === 'to') {
                    return JSON.parse(value);
                }
                return value;
            },
            complete: function(results) {
                data3 = results.data;
                migrationLayer = new L.migrationLayer({
                    map: lrmap,
                    data: data3,
                    pulseRadius:30,
                    pulseBorderWidth:3,
                    arcWidth:1,
                    arcLabel:true,
                    arcLabelFont:'30px sans-serif',
                    maxWidth:20
                    }
                );
                migrationLayer.addTo(lrmap);
                populateDropdown('toDropdown');
                populateDropdown('fromDropdown');
                tCount = sumCol(data3, 'value');
                updateFilters();
            }
        });

        
        document.getElementById("toDropdown").addEventListener("change", updateFilters);
        document.getElementById("fromDropdown").addEventListener("change", updateFilters);

        var least = document.getElementById("atLeast");
        var most = document.getElementById("atMost");
        var minWeight = document.getElementById("minPairWeight");

        least.onchange = updateFilters;
        most.onchange = updateFilters;
        minWeight.onchange = updateFilters;

        var leastDisplay = document.getElementById("leastDisplay");
        var mostDisplay = document.getElementById("mostDisplay");
        var minWeightDisplay = document.getElementById("minWeightDisplay");
        var countDisplay = document.getElementById("countDisplay");
        

        function updateFilters() {
            mostDisplay.innerHTML = most.value;
            leastDisplay.innerHTML = least.value;
            minWeightDisplay.innerHTML = minWeight.value;

            filteredData = data3.filter(row => row.toTotal >= least.value);
            filteredData = filteredData.filter(row => row.toTotal <= most.value);
            filteredData = filteredData.filter(row => row.value >= minWeight.value);

            const from = document.getElementById('fromDropdown').value;
            if (!(from==='')){
                filteredData = filteredData.filter(row => row.fromLabel === from);
            }

            const to = document.getElementById('toDropdown').value;
            if (!(to==='')){
                filteredData = filteredData.filter(row => row.toLabel === to);
            }

            if (filteredData.length>0) {
                migrationLayer.setData(filteredData);
                migrationLayer.show()
                countDisplay.innerHTML = `Показани: ${sumCol(filteredData, 'value')} от ${tCount} души.`
            } else {
                migrationLayer.hide(); 
            }
        }

        function populateDropdown(dropdownID) {

            const labels = {
              'toDropdown' : 'toLabel', 
              'fromDropdown' : 'fromLabel',
            }

            const promptText = {
              'toDropdown' : '<option value="" selected>место на смърт</option>',
              'fromDropdown' : '<option value="" selected>место на раждане</option>',
            }

            const dropdown = document.getElementById(dropdownID);
            const columns = getColumnValues(data3, labels[dropdownID]);

            dropdown.innerHTML = promptText[dropdownID];

            columns.forEach((column) => {
                const option = document.createElement("option");
                option.value = column;
                option.textContent = column;
                dropdown.appendChild(option);
            });

        }

        function getColumnValues(data, col) {
            var columns = [];

            data.forEach((row) => {
                if (!columns.includes(row[col])) {
                    columns.push(row[col]);
                }
            });

            return columns;
        }

        function sumCol(data, col) {
            return data.reduce((sum, row) => sum + row[col], 0);
        }

    </script>
</body>
</html>
